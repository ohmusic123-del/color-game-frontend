<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Withdraw • BIGWIN</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>

<!-- HEADER -->
<div class="header">
  <h2>Withdraw</h2>
  <button onclick="history.back()">← Back</button>
</div>

<!-- CONTENT -->
<div class="container page-padding">

  <!-- WITHDRAWAL METHOD -->
  <div class="card">
    <div class="card-title">Withdrawal Method</div>
    
    <div id="methodStatus" style="margin-bottom: 12px; color: #94a3b8; font-size: 14px;">
      Loading...
    </div>

    <button class="btn btn-primary" onclick="location.href='withdrawal-method.html'" style="width: 100%;">
      ⚙️ Manage Withdrawal Method
    </button>
  </div>

  <!-- AMOUNT -->
  <div class="card">
    <div class="card-title">Withdraw Amount</div>

    <input
      type="number"
      id="amount"
      placeholder="Minimum ₹100"
      class="input"
      min="100"
    />

    <div class="quick-amounts">
      <button onclick="setAmount(500)">₹500</button>
      <button onclick="setAmount(1000)">₹1000</button>
      <button onclick="setAmount(2000)">₹2000</button>
      <button onclick="setAmount(5000)">₹5000</button>
    </div>

    <button class="btn btn-danger" onclick="withdraw()">Submit Withdrawal</button>
  </div>

  <!-- INFO -->
  <div class="card info-card">
    <p>• Minimum withdrawal ₹100</p>
    <p>• Deposit & wagering required</p>
    <p>• Withdrawal processed by admin</p>
  </div>

  <!-- WITHDRAWAL HISTORY -->
  <div class="card">
    <h3 style="margin-bottom: 12px;">Withdrawal History</h3>
    <div id="withdrawHistory">
      <p style="text-align: center; color: #94a3b8;">Loading...</p>
    </div>
  </div>

</div>

<!-- FOOTER -->
<div class="footer">
  <a href="home.html">Home</a>
  <a href="game.html">Game</a>
  <a href="wallet.html">Wallet</a>
  <a href="profile.html">Profile</a>
</div>

<script src="js/api.js"></script>
<script src="js/auth.js"></script>
<script>
  async function loadWithdrawPage() {
    // Load withdrawal method status
    const userRes = await fetch(API + "/profile", {
      headers: { Authorization: localStorage.getItem("token") }
    });
    const userData = await userRes.json();

    const methodStatus = document.getElementById("methodStatus");
    
    if (userData.withdrawMethod && userData.withdrawDetails) {
      if (userData.withdrawMethod === "upi") {
        methodStatus.innerHTML = `✅ UPI: ${userData.withdrawDetails.upiId || "Not set"}`;
      } else if (userData.withdrawMethod === "bank") {
        methodStatus.innerHTML = `✅ Bank: ${userData.withdrawDetails.accountNumber || "Not set"}`;
      }
    } else {
      methodStatus.innerHTML = `⚠️ No withdrawal method set`;
      methodStatus.style.color = "#fbbf24";
    }

    // Load withdrawal history
    loadWithdrawHistory();
  }

  async function loadWithdrawHistory() {
    try {
      const res = await fetch(API + "/wallet/withdraw-history", {
        headers: { Authorization: localStorage.getItem("token") }
      });

      const history = await res.json();
      const container = document.getElementById("withdrawHistory");

      if (!history || history.length === 0) {
        container.innerHTML = "<p style='text-align: center; color: #94a3b8;'>No withdrawals yet</p>";
        return;
      }

      container.innerHTML = history.map(w => `
        <div style="
          background: rgba(255,255,255,0.05);
          padding: 12px;
          border-radius: 8px;
          margin-bottom: 8px;
        ">
          <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
            <strong>₹${w.amount}</strong>
            <span style="
              padding: 4px 12px;
              border-radius: 12px;
              font-size: 11px;
              font-weight: 700;
              ${w.status === 'PENDING' ? 'background: #fbbf24; color: #000;' : ''}
              ${w.status === 'APPROVED' ? 'background: #22c55e; color: #000;' : ''}
              ${w.status === 'REJECTED' ? 'background: #ef4444; color: #fff;' : ''}
            ">${w.status}</span>
          </div>
          <div style="font-size: 12px; color: #94a3b8;">
            ${new Date(w.createdAt).toLocaleString()}
          </div>
          ${w.adminNote ? `<div style="font-size: 12px; color: #fbbf24; margin-top: 4px;">Note: ${w.adminNote}</div>` : ''}
        </div>
      `).join("");

    } catch (err) {
      console.error("Withdraw history error:", err);
    }
  }

  function setAmount(value) {
    document.getElementById("amount").value = value;
  }

  async function withdraw() {
    const amount = Number(document.getElementById("amount").value);

    if (amount < 100) {
      alert("Minimum withdrawal is ₹100");
      return;
    }

    const res = await fetch(API + "/withdraw", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: localStorage.getItem("token")
      },
      body: JSON.stringify({ amount })
    });

    const data = await res.json();

    if (!res.ok) {
      alert(data.error || "Withdrawal failed");
      return;
    }

    alert("Withdrawal request submitted successfully!");
    document.getElementById("amount").value = "";
    loadWithdrawHistory();
  }

  loadWithdrawPage();
</script>
</body>
</html>
