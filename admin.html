<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BigWin77 - Admin Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #4F46E5; --primary-dark: #4338CA; --secondary: #10B981;
            --danger: #EF4444; --warning: #F59E0B; --dark: #1F2937;
            --light: #F9FAFB; --border: #E5E7EB; --text: #374151;
            --text-light: #6B7280; --success: #10B981;
        }
        body { font-family: 'Inter', sans-serif; background: var(--light); color: var(--text); }
        .sidebar {
            position: fixed; left: 0; top: 0; width: 260px; height: 100vh;
            background: white; border-right: 1px solid var(--border);
            overflow-y: auto; z-index: 1000;
        }
        .sidebar-header { padding: 24px 20px; border-bottom: 1px solid var(--border); }
        .sidebar-logo {
            font-size: 24px; font-weight: 700; color: var(--primary);
            display: flex; align-items: center; gap: 10px;
        }
        .sidebar-menu { padding: 20px 0; }
        .menu-item {
            padding: 12px 20px; display: flex; align-items: center; gap: 12px;
            color: var(--text); text-decoration: none; cursor: pointer;
            border-left: 3px solid transparent;
        }
        .menu-item:hover { background: var(--light); color: var(--primary); }
        .menu-item.active {
            background: #EEF2FF; color: var(--primary);
            border-left-color: var(--primary); font-weight: 500;
        }
        .menu-item i { width: 20px; text-align: center; }
        .main-content { margin-left: 260px; padding: 24px; min-height: 100vh; }
        .top-bar {
            background: white; padding: 16px 24px; border-radius: 12px;
            margin-bottom: 24px; display: flex; justify-content: space-between;
            align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .page-title { font-size: 24px; font-weight: 600; color: var(--dark); }
        .user-info { display: flex; align-items: center; gap: 12px; }
        .user-avatar {
            width: 40px; height: 40px; border-radius: 50%;
            background: var(--primary); color: white;
            display: flex; align-items: center; justify-content: center; font-weight: 600;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px; margin-bottom: 24px;
        }
        .stat-card {
            background: white; padding: 24px; border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .stat-header {
            display: flex; justify-content: space-between;
            align-items: flex-start; margin-bottom: 16px;
        }
        .stat-icon {
            width: 48px; height: 48px; border-radius: 12px;
            display: flex; align-items: center; justify-content: center; font-size: 20px;
        }
        .stat-icon.primary { background: #EEF2FF; color: var(--primary); }
        .stat-icon.success { background: #D1FAE5; color: var(--success); }
        .stat-icon.warning { background: #FEF3C7; color: var(--warning); }
        .stat-icon.danger { background: #FEE2E2; color: var(--danger); }
        .stat-value { font-size: 32px; font-weight: 700; color: var(--dark); margin-bottom: 4px; }
        .stat-label { font-size: 14px; color: var(--text-light); }
        .content-section { display: none; }
        .content-section.active { display: block; }
        .card {
            background: white; border-radius: 12px; padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 24px;
        }
        .card-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid var(--border);
        }
        .card-title { font-size: 18px; font-weight: 600; color: var(--dark); }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        thead { background: var(--light); }
        th {
            padding: 12px 16px; text-align: left; font-weight: 600;
            font-size: 13px; color: var(--text-light); text-transform: uppercase;
        }
        td { padding: 16px; border-bottom: 1px solid var(--border); font-size: 14px; }
        tbody tr:hover { background: var(--light); }
        .badge {
            padding: 4px 12px; border-radius: 12px;
            font-size: 12px; font-weight: 500; display: inline-block;
        }
        .badge.success { background: #D1FAE5; color: var(--success); }
        .badge.danger { background: #FEE2E2; color: var(--danger); }
        .badge.warning { background: #FEF3C7; color: var(--warning); }
        .badge.primary { background: #EEF2FF; color: var(--primary); }
        .btn {
            padding: 10px 20px; border: none; border-radius: 8px;
            font-size: 14px; font-weight: 500; cursor: pointer;
            display: inline-flex; align-items: center; gap: 8px;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 13px; }
        .input-group { margin-bottom: 16px; }
        .input-group label {
            display: block; margin-bottom: 8px; font-weight: 500;
            font-size: 14px; color: var(--dark);
        }
        input, select, textarea {
            width: 100%; padding: 12px 16px; border: 1px solid var(--border);
            border-radius: 8px; font-size: 14px; font-family: inherit;
        }
        input:focus, select:focus, textarea:focus {
            outline: none; border-color: var(--primary);
        }
        .modal {
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%; background: rgba(0,0,0,0.5);
            z-index: 2000; align-items: center; justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white; border-radius: 16px;
            width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto;
        }
        .modal-header {
            padding: 24px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .modal-title { font-size: 20px; font-weight: 600; color: var(--dark); }
        .modal-close {
            width: 32px; height: 32px; border: none;
            background: var(--light); border-radius: 8px; cursor: pointer;
        }
        .modal-body { padding: 24px; }
        .modal-footer {
            padding: 24px; border-top: 1px solid var(--border);
            display: flex; gap: 12px; justify-content: flex-end;
        }
        .logout-btn {
            padding: 8px 16px; background: #FEE2E2; color: var(--danger);
            border: none; border-radius: 8px; cursor: pointer;
            font-size: 14px; font-weight: 500;
        }
        .logout-btn:hover { background: var(--danger); color: white; }
        .text-center { text-align: center; }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <i class="fas fa-crown"></i>
                <span>BigWin77</span>
            </div>
        </div>
        <div class="sidebar-menu">
            <a class="menu-item active" data-section="dashboard">
                <i class="fas fa-chart-line"></i>
                <span>Dashboard</span>
            </a>
            <a class="menu-item" data-section="users">
                <i class="fas fa-users"></i>
                <span>Users Management</span>
            </a>
            <a class="menu-item" data-section="gift-codes">
                <i class="fas fa-gift"></i>
                <span>Gift Codes</span>
            </a>
            <a class="menu-item" data-section="deposits">
                <i class="fas fa-wallet"></i>
                <span>Deposits</span>
            </a>
            <a class="menu-item" data-section="withdrawals">
                <i class="fas fa-money-bill-wave"></i>
                <span>Withdrawals</span>
            </a>
            <a class="menu-item" data-section="monitor-users">
                <i class="fas fa-user-shield"></i>
                <span>Monitor Users</span>
            </a>
            <a class="menu-item" data-section="analytics">
                <i class="fas fa-chart-pie"></i>
                <span>Analytics</span>
            </a>
        </div>
    </div>

    <div class="main-content">
        <div class="top-bar">
            <h1 class="page-title" id="pageTitle">Dashboard</h1>
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">A</div>
                <span id="adminName">Admin</span>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>

        <div class="content-section active" id="dashboard">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value" id="totalUsers">0</div>
                            <div class="stat-label">Total Users</div>
                        </div>
                        <div class="stat-icon primary">
                            <i class="fas fa-users"></i>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value" id="totalDeposits">₹0</div>
                            <div class="stat-label">Total Deposits</div>
                        </div>
                        <div class="stat-icon success">
                            <i class="fas fa-rupee-sign"></i>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value" id="pendingWithdrawals">0</div>
                            <div class="stat-label">Pending Withdrawals</div>
                        </div>
                        <div class="stat-icon warning">
                            <i class="fas fa-clock"></i>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value" id="totalGiftCodes">0</div>
                            <div class="stat-label">Total Gift Codes</div>
                        </div>
                        <div class="stat-icon danger">
                            <i class="fas fa-gift"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="content-section" id="users">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">All Users</h3>
                    <button class="btn btn-primary" onclick="loadUsers()">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Mobile</th>
                                <th>Wallet</th>
                                <th>Bonus</th>
                                <th>Total Deposit</th>
                                <th>Total Withdraw</th>
                                <th>Registered</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTable">
                            <tr><td colspan="7" class="text-center">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="content-section" id="gift-codes">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Gift Codes</h3>
                    <button class="btn btn-primary" onclick="openCreateGiftCodeModal()">
                        <i class="fas fa-plus"></i> Create Gift Code
                    </button>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Amount</th>
                                <th>Type</th>
                                <th>Created By</th>
                                <th>Redemptions</th>
                                <th>Status</th>
                                <th>Expires</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="giftCodesTable">
                            <tr><td colspan="8" class="text-center">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="content-section" id="deposits">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Deposits</h3>
                    <button class="btn btn-primary" onclick="loadDeposits()">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Mobile</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody id="depositsTable">
                            <tr><td colspan="5" class="text-center">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="content-section" id="withdrawals">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Withdrawals</h3>
                    <button class="btn btn-primary" onclick="loadWithdrawals()">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Mobile</th>
                                <th>Amount</th>
                                <th>Method</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="withdrawalsTable">
                            <tr><td colspan="7" class="text-center">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="content-section" id="monitor-users">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Monitor Users</h3>
                    <button class="btn btn-primary" onclick="openCreateMonitorModal()">
                        <i class="fas fa-plus"></i> Create Monitor
                    </button>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Display Name</th>
                                <th>Total Logins</th>
                                <th>Last Login</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="monitorUsersTable">
                            <tr><td colspan="6" class="text-center">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="content-section" id="analytics">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Platform Analytics</h3>
                </div>
                <div id="analyticsContent">
                    <div class="loading">Loading analytics...</div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="createGiftCodeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create Gift Code</h3>
                <button class="modal-close" onclick="closeCreateGiftCodeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label>Amount (₹)</label>
                    <input type="number" id="giftAmount" min="10" max="10000" placeholder="10-10000">
                </div>
                <div class="input-group">
                    <label>Type</label>
                    <select id="giftType">
                        <option value="one-to-one">One-to-One</option>
                        <option value="one-to-many">One-to-Many</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Validity (Days)</label>
                    <input type="number" id="validityDays" value="30" min="1">
                </div>
                <div class="input-group">
                    <label>Description</label>
                    <textarea id="giftDescription" rows="2"></textarea>
                </div>
                <div class="input-group">
                    <label>User Mobile (to deduct from)</label>
                    <input type="text" id="forUserMobile" placeholder="Mobile number">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeCreateGiftCodeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="createGiftCode()">Create</button>
            </div>
        </div>
    </div>

    <div class="modal" id="createMonitorModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create Monitor User</h3>
                <button class="modal-close" onclick="closeCreateMonitorModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label>Username</label>
                    <input type="text" id="monitorUsername">
                </div>
                <div class="input-group">
                    <label>Password</label>
                    <input type="password" id="monitorPassword">
                </div>
                <div class="input-group">
                    <label>Display Name</label>
                    <input type="text" id="monitorDisplayName">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeCreateMonitorModal()">Cancel</button>
                <button class="btn btn-primary" onclick="createMonitorUser()">Create</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://color-game-backend1.onrender.com';
        let token = localStorage.getItem('adminToken');
        if (!token) window.location.href = 'admin-login.html';

        const adminData = JSON.parse(localStorage.getItem('adminData') || '{}');
        if (adminData.username) {
            document.getElementById('adminName').textContent = adminData.username;
            document.getElementById('userAvatar').textContent = adminData.username.charAt(0).toUpperCase();
        }

        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', function() {
                const section = this.dataset.section;
                document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
                this.classList.add('active');
                document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
                document.getElementById(section).classList.add('active');
                const titles = {
                    'dashboard': 'Dashboard', 'users': 'Users Management',
                    'gift-codes': 'Gift Codes', 'deposits': 'Deposits',
                    'withdrawals': 'Withdrawals', 'monitor-users': 'Monitor Users',
                    'analytics': 'Analytics'
                };
                document.getElementById('pageTitle').textContent = titles[section] || 'Dashboard';
                loadSectionData(section);
            });
        });

        function loadSectionData(section) {
            const map = {
                'dashboard': loadDashboard, 'users': loadUsers,
                'gift-codes': loadGiftCodes, 'deposits': loadDeposits,
                'withdrawals': loadWithdrawals, 'monitor-users': loadMonitorUsers,
                'analytics': loadAnalytics
            };
            if (map[section]) map[section]();
        }

        async function apiCall(endpoint, method = 'GET', body = null) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            };
            if (body) options.body = JSON.stringify(body);
            
            try {
                const response = await fetch(`${API_URL}${endpoint}`, options);
                const data = await response.json();
                if (!response.ok) {
                    if (response.status === 401) {
                        alert('Session expired. Please login again.');
                        logout();
                        return null;
                    }
                    throw new Error(data.error || 'Request failed');
                }
                return data;
            } catch (error) {
                console.error('API Error:', error);
                alert(error.message);
                return null;
            }
        }

        async function loadDashboard() {
            try {
                const stats = await apiCall('/admin/dashboard-stats');
                if (stats) {
                    document.getElementById('totalUsers').textContent = stats.totalUsers || 0;
                    document.getElementById('totalDeposits').textContent = `₹${(stats.totalDeposits || 0).toFixed(2)}`;
                    document.getElementById('pendingWithdrawals').textContent = stats.pendingWithdraws || 0;
                }
                const giftCodes = await apiCall('/admin/giftcodes');
                if (giftCodes) document.getElementById('totalGiftCodes').textContent = giftCodes.length;
            } catch (error) {
                console.error('Dashboard error:', error);
            }
        }

        async function loadUsers() {
            const tbody = document.getElementById('usersTable');
            tbody.innerHTML = '<tr><td colspan="7" class="text-center">Loading...</td></tr>';
            const users = await apiCall('/admin/users');
            if (users) {
                tbody.innerHTML = users.map(u => `
                    <tr>
                        <td>${u.mobile}</td>
                        <td>₹${(u.wallet || 0).toFixed(2)}</td>
                        <td>₹${(u.bonus || 0).toFixed(2)}</td>
                        <td>₹${(u.totalDeposit || 0).toFixed(2)}</td>
                        <td>₹${(u.totalWithdraw || 0).toFixed(2)}</td>
                        <td>${new Date(u.createdAt).toLocaleDateString()}</td>
                        <td>
                            <button class="btn btn-sm ${u.isBanned ? 'btn-success' : 'btn-danger'}" 
                                    onclick="toggleBanUser('${u.mobile}', ${!u.isBanned})">
                                ${u.isBanned ? 'Unban' : 'Ban'}
                            </button>
                        </td>
                    </tr>
                `).join('') || '<tr><td colspan="7" class="text-center">No users</td></tr>';
            }
        }

        async function toggleBanUser(mobile, ban) {
            const endpoint = ban ? `/admin/user/${mobile}/ban` : `/admin/user/${mobile}/unban`;
            const result = await apiCall(endpoint, 'POST');
            if (result) {
                alert(ban ? 'User banned' : 'User unbanned');
                loadUsers();
            }
        }

        async function loadGiftCodes() {
            const tbody = document.getElementById('giftCodesTable');
            tbody.innerHTML = '<tr><td colspan="8" class="text-center">Loading...</td></tr>';
            const giftCodes = await apiCall('/admin/giftcodes');
            if (giftCodes) {
                tbody.innerHTML = giftCodes.map(gc => `
                    <tr>
                        <td><strong>${gc.code}</strong></td>
                        <td>₹${gc.amount}</td>
                        <td>${gc.type}</td>
                        <td>${gc.createdBy}</td>
                        <td>${gc.redemptionCount}/${gc.maxRedemptions}</td>
                        <td><span class="badge ${getBadgeClass(gc.status)}">${gc.status}</span></td>
                        <td>${new Date(gc.expiresAt).toLocaleDateString()}</td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="deleteGiftCode('${gc._id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('') || '<tr><td colspan="8" class="text-center">No gift codes</td></tr>';
            }
        }

        function openCreateGiftCodeModal() {
            document.getElementById('createGiftCodeModal').classList.add('active');
        }

        function closeCreateGiftCodeModal() {
            document.getElementById('createGiftCodeModal').classList.remove('active');
        }

        async function createGiftCode() {
            const amount = parseFloat(document.getElementById('giftAmount').value);
            const type = document.getElementById('giftType').value;
            const validityDays = parseInt(document.getElementById('validityDays').value);
            const description = document.getElementById('giftDescription').value;
            const forUserMobile = document.getElementById('forUserMobile').value;

            if (!amount || !forUserMobile) {
                alert('Please fill amount and user mobile');
                return;
            }

            const result = await apiCall('/admin/create-giftcode', 'POST', {
                amount, type, validityDays, description, forUserMobile
            });

            if (result) {
                alert(`Gift code created: ${result.giftCode.code}`);
                closeCreateGiftCodeModal();
                loadGiftCodes();
            }
        }

        async function deleteGiftCode(id) {
            if (!confirm('Delete this gift code?')) return;
            const result = await apiCall(`/admin/giftcode/${id}`, 'DELETE');
            if (result) {
                alert('Gift code deleted');
                loadGiftCodes();
            }
        }

        async function loadDeposits() {
            const tbody = document.getElementById('depositsTable');
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">Loading...</td></tr>';
            const deposits = await apiCall('/admin/deposits');
            if (deposits) {
                tbody.innerHTML = deposits.map(d => `
                    <tr>
                        <td>${d._id.substring(0,8)}</td>
                        <td>${d.mobile}</td>
                        <td>₹${d.amount}</td>
                        <td><span class="badge ${getBadgeClass(d.status)}">${d.status}</span></td>
                        <td>${new Date(d.createdAt).toLocaleString()}</td>
                    </tr>
                `).join('') || '<tr><td colspan="5" class="text-center">No deposits</td></tr>';
            }
        }

        async function loadWithdrawals() {
            const tbody = document.getElementById('withdrawalsTable');
            tbody.innerHTML = '<tr><td colspan="7" class="text-center">Loading...</td></tr>';
            const withdrawals = await apiCall('/admin/withdraws');
            if (withdrawals) {
                tbody.innerHTML = withdrawals.map(w => `
                    <tr>
                        <td>${w._id.substring(0,8)}</td>
                        <td>${w.mobile}</td>
                        <td>₹${w.amount}</td>
                        <td>${w.method}</td>
                        <td><span class="badge ${getBadgeClass(w.status)}">${w.status}</span></td>
                        <td>${new Date(w.createdAt).toLocaleString()}</td>
                        <td>
                            ${w.status === 'PENDING' ? `
                                <button class="btn btn-sm btn-success" onclick="handleWithdraw('${w._id}', 'approve')">
                                    Approve
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="handleWithdraw('${w._id}', 'reject')">
                                    Reject
                                </button>
                            ` : '-'}
                        </td>
                    </tr>
                `).join('') || '<tr><td colspan="7" class="text-center">No withdrawals</td></tr>';
            }
        }

        async function handleWithdraw(id, action) {
            if (!confirm(`${action} this withdrawal?`)) return;
            const result = await apiCall(`/admin/withdraw/${id}`, 'POST', { 
                status: action === 'approve' ? 'APPROVED' : 'REJECTED' 
            });
            if (result) {
                alert(`Withdrawal ${action}d`);
                loadWithdrawals();
            }
        }

        async function loadMonitorUsers() {
            const tbody = document.getElementById('monitorUsersTable');
            tbody.innerHTML = '<tr><td colspan="6" class="text-center">Loading...</td></tr>';
            const monitors = await apiCall('/admin/monitor-users');
            if (monitors) {
                tbody.innerHTML = monitors.map(m => `
                    <tr>
                        <td>${m.username}</td>
                        <td>${m.displayName}</td>
                        <td>${m.totalLogins || 0}</td>
                        <td>${m.lastLogin ? new Date(m.lastLogin).toLocaleString() : 'Never'}</td>
                        <td><span class="badge ${m.active ? 'success' : 'danger'}">${m.active ? 'Active' : 'Inactive'}</span></td>
                        <td>
                            <button class="btn btn-sm ${m.active ? 'btn-danger' : 'btn-success'}" 
                                    onclick="toggleMonitor('${m._id}', ${!m.active})">
                                ${m.active ? 'Disable' : 'Enable'}
                            </button>
                        </td>
                    </tr>
                `).join('') || '<tr><td colspan="6" class="text-center">No monitors</td></tr>';
            }
        }

        function openCreateMonitorModal() {
            document.getElementById('createMonitorModal').classList.add('active');
        }

        function closeCreateMonitorModal() {
            document.getElementById('createMonitorModal').classList.remove('active');
        }

        async function createMonitorUser() {
            const username = document.getElementById('monitorUsername').value;
            const password = document.getElementById('monitorPassword').value;
            const displayName = document.getElementById('monitorDisplayName').value;

            if (!username || !password) {
                alert('Username and password required');
                return;
            }

            const result = await apiCall('/admin/monitor-user', 'POST', {
                username, password, displayName: displayName || username
            });

            if (result) {
                alert('Monitor user created');
                closeCreateMonitorModal();
                loadMonitorUsers();
            }
        }

        async function toggleMonitor(id, active) {
            const result = await apiCall(`/admin/monitor-user/${id}/toggle`, 'POST', { active });
            if (result) {
                alert(`Monitor ${active ? 'enabled' : 'disabled'}`);
                loadMonitorUsers();
            }
        }

        async function loadAnalytics() {
            const stats = await apiCall('/admin/stats');
            const content = document.getElementById('analyticsContent');
            if (stats) {
                content.innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">₹${(stats.totalRevenue || 0).toFixed(2)}</div>
                            <div class="stat-label">Total Revenue</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${stats.totalBets || 0}</div>
                            <div class="stat-label">Total Bets</div>
                        </div>
                    </div>
                `;
            }
        }

        function getBadgeClass(status) {
            const map = {
                'SUCCESS': 'success', 'APPROVED': 'success', 'active': 'success',
                'PENDING': 'warning', 'FAILED': 'danger',
                'REJECTED': 'danger', 'expired': 'danger'
            };
            return map[status] || 'primary';
        }

        function logout() {
            localStorage.removeItem('adminToken');
            localStorage.removeItem('adminData');
            window.location.href = 'admin-login.html';
        }

        loadDashboard();
    </script>
</body>
</html>
