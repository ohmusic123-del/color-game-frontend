<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BigWin77 - Admin Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #4F46E5;
            --primary-dark: #4338CA;
            --secondary: #10B981;
            --danger: #EF4444;
            --warning: #F59E0B;
            --dark: #1F2937;
            --light: #F9FAFB;
            --border: #E5E7EB;
            --text: #374151;
            --text-light: #6B7280;
            --success: #10B981;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--light);
            color: var(--text);
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 260px;
            height: 100vh;
            background: white;
            border-right: 1px solid var(--border);
            overflow-y: auto;
            transition: all 0.3s;
            z-index: 1000;
        }

        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-logo {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar-menu {
            padding: 20px 0;
        }

        .menu-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text);
            text-decoration: none;
            transition: all 0.2s;
            cursor: pointer;
            border-left: 3px solid transparent;
        }

        .menu-item:hover {
            background: var(--light);
            color: var(--primary);
        }

        .menu-item.active {
            background: #EEF2FF;
            color: var(--primary);
            border-left-color: var(--primary);
            font-weight: 500;
        }

        .menu-item i {
            width: 20px;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            margin-left: 260px;
            padding: 24px;
            min-height: 100vh;
        }

        .top-bar {
            background: white;
            padding: 16px 24px;
            border-radius: 12px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .page-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--dark);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .stat-icon.primary {
            background: #EEF2FF;
            color: var(--primary);
        }

        .stat-icon.success {
            background: #D1FAE5;
            color: var(--success);
        }

        .stat-icon.warning {
            background: #FEF3C7;
            color: var(--warning);
        }

        .stat-icon.danger {
            background: #FEE2E2;
            color: var(--danger);
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-light);
        }

        /* Content Section */
        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        /* Card */
        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 24px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark);
        }

        /* Table */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: var(--light);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            color: var(--text);
            border-bottom: 2px solid var(--border);
        }

        td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
        }

        tr:hover {
            background: var(--light);
        }

        /* Buttons */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 13px;
        }

        /* Badge */
        .badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .badge.success {
            background: #D1FAE5;
            color: var(--success);
        }

        .badge.danger {
            background: #FEE2E2;
            color: var(--danger);
        }

        .badge.warning {
            background: #FEF3C7;
            color: var(--warning);
        }

        .badge.primary {
            background: #EEF2FF;
            color: var(--primary);
        }

        /* Filter Bar */
        .filter-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-bar input,
        .filter-bar select {
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            min-width: 200px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .input-group {
            margin-bottom: 16px;
        }

        .input-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            font-size: 14px;
        }

        .input-group input,
        .input-group select,
        .input-group textarea {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
        }

        .text-center {
            text-align: center;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-light);
        }

        .close-btn:hover {
            color: var(--danger);
        }

        .logout-btn {
            background: var(--danger);
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
        }

        .logout-btn:hover {
            opacity: 0.9;
        }

        .last-updated {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 16px;
        }

        .activity-item {
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .activity-info {
            flex: 1;
        }

        .activity-amount {
            text-align: right;
        }

        .activity-time {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <i class="fas fa-shield-alt"></i>
                BigWin77 Admin
            </div>
        </div>
        <div class="sidebar-menu">
            <div class="menu-item active" data-section="dashboard">
                <i class="fas fa-home"></i>
                <span>Dashboard</span>
            </div>
            <div class="menu-item" data-section="users">
                <i class="fas fa-users"></i>
                <span>Users</span>
            </div>
            <div class="menu-item" data-section="gift-codes">
                <i class="fas fa-gift"></i>
                <span>Gift Codes</span>
            </div>
            <div class="menu-item" data-section="deposits">
                <i class="fas fa-download"></i>
                <span>Deposits</span>
            </div>
            <div class="menu-item" data-section="withdrawals">
                <i class="fas fa-upload"></i>
                <span>Withdrawals</span>
            </div>
            <div class="menu-item" data-section="bets">
                <i class="fas fa-dice"></i>
                <span>Bets History</span>
            </div>
            <div class="menu-item" data-section="rounds">
                <i class="fas fa-sync"></i>
                <span>Game Rounds</span>
            </div>
            <div class="menu-item" data-section="monitor-users">
                <i class="fas fa-user-shield"></i>
                <span>Monitor Users</span>
            </div>
            <div class="menu-item" data-section="referrals">
                <i class="fas fa-share-nodes"></i>
                <span>Referrals</span>
            </div>
            <div class="menu-item" data-section="analytics">
                <i class="fas fa-chart-line"></i>
                <span>Analytics</span>
            </div>
            <div class="menu-item" data-section="settings">
                <i class="fas fa-cog"></i>
                <span>Settings</span>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Top Bar -->
        <div class="top-bar">
            <div>
                <h1 class="page-title" id="pageTitle">Dashboard</h1>
            </div>
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">A</div>
                <div>
                    <div style="font-weight: 600;" id="adminName">Admin</div>
                    <button class="logout-btn" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard" class="content-section active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon primary">
                            <i class="fas fa-users"></i>
                        </div>
                    </div>
                    <div class="stat-value" id="totalUsers">0</div>
                    <div class="stat-label">Total Users</div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon success">
                            <i class="fas fa-rupee-sign"></i>
                        </div>
                    </div>
                    <div class="stat-value" id="totalRevenue">₹0</div>
                    <div class="stat-label">Total Revenue</div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon warning">
                            <i class="fas fa-clock"></i>
                        </div>
                    </div>
                    <div class="stat-value" id="pendingWithdrawals">0</div>
                    <div class="stat-label">Pending Withdrawals</div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon danger">
                            <i class="fas fa-gift"></i>
                        </div>
                    </div>
                    <div class="stat-value" id="activeGiftCodes">0</div>
                    <div class="stat-label">Active Gift Codes</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Recent Activity</h3>
                    <button class="btn btn-sm btn-primary" onclick="loadRecentActivity()">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                </div>
                <div id="recentActivity">
                    <p class="text-center">Loading...</p>
                </div>
                <div class="last-updated">
                    Last updated: <span id="lastUpdated">--</span>
                </div>
            </div>
        </div>

        <!-- Users Section -->
        <div id="users" class="content-section">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Users Management</h3>
                    <button class="btn btn-primary" onclick="loadUsers()">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                </div>
                <div class="filter-bar">
                    <input type="text" id="userSearch" placeholder="Search by mobile..." onkeyup="filterUsers()">
                    <select id="userStatusFilter" onchange="filterUsers()">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="banned">Banned</option>
                    </select>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Mobile</th>
                                <th>Wallet</th>
                                <th>Bonus</th>
                                <th>Total Deposit</th>
                                <th>Total Withdraw</th>
                                <th>Status</th>
                                <th>Joined</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTable">
                            <tr><td colspan="8" class="text-center">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Gift Codes Section -->
        <div id="gift-codes" class="content-section">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Gift Codes</h3>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-primary" onclick="openCreateGiftCodeModal()">
                            <i class="fas fa-plus"></i> Create Gift Code
                        </button>
                        <button class="btn btn-primary" onclick="loadGiftCodes()">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                </div>
                <div class="filter-bar">
                    <input type="text" id="giftCodeSearch" placeholder="Search by code..." onkeyup="filterGiftCodes()">
                    <select id="giftCodeStatusFilter" onchange="filterGiftCodes()">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="expired">Expired</option>
                        <option value="fully-redeemed">Fully Redeemed</option>
                    </select>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Amount</th>
                                <th>Type</th>
                                <th>Max Redemptions</th>
                                <th>Redeemed</th>
                                <th>Expires</th>
                                <th>Status</th>
                                <th>Created By</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="giftCodesTable">
                            <tr><td colspan="9" class="text-center">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Deposits Section -->
        <div id="deposits" class="content-section">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Deposits</h3>
                    <button class="btn btn-primary" onclick="loadDeposits()">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                </div>
                <div class="filter-bar">
                    <input type="text" id="depositSearch" placeholder="Search by mobile..." onkeyup="filterDeposits()">
                    <select id="depositStatusFilter" onchange="filterDeposits()">
                        <option value="">All Status</option>
                        <option value="SUCCESS">Success</option>
                        <option value="PENDING">Pending</option>
                        <option value="FAILED">Failed</option>
                    </select>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Mobile</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Method</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="depositsTable">
                            <tr><td colspan="7" class="text-center">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Withdrawals Section -->
        <div id="withdrawals" class="content-section">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Withdrawals</h3>
                    <button class="btn btn-primary" onclick="loadWithdrawals()">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                </div>
                <div class="filter-bar">
                    <input type="text" id="withdrawalSearch" placeholder="Search by mobile..." onkeyup="filterWithdrawals()">
                    <select id="withdrawalStatusFilter" onchange="filterWithdrawals()">
                        <option value="">All Status</option>
                        <option value="APPROVED">Approved</option>
                        <option value="PENDING">Pending</option>
                        <option value="REJECTED">Rejected</option>
                    </select>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Mobile</th>
                                <th>Amount</th>
                                <th>Account</th>
                                <th>IFSC</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="withdrawalsTable">
                            <tr><td colspan="7" class="text-center">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Bets Section -->
        <div id="bets" class="content-section">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Bets History</h3>
                    <button class="btn btn-primary" onclick="loadBets()">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                </div>
                <div class="filter-bar">
                    <input type="text" id="betSearch" placeholder="Search by mobile..." onkeyup="filterBets()">
                    <select id="betResultFilter" onchange="filterBets()">
                        <option value="">All Results</option>
                        <option value="WIN">Win</option>
                        <option value="LOSS">Loss</option>
                    </select>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Mobile</th>
                                <th>Round</th>
                                <th>Bet Type</th>
                                <th>Amount</th>
                                <th>Result</th>
                                <th>Win Amount</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody id="betsTable">
                            <tr><td colspan="7" class="text-center">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Rounds Section -->
        <div id="rounds" class="content-section">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Game Rounds</h3>
                    <button class="btn btn-primary" onclick="loadRounds()">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Round ID</th>
                                <th>Winner</th>
                                <th>Total Bets</th>
                                <th>Total Amount</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody id="roundsTable">
                            <tr><td colspan="5" class="text-center">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Monitor Users Section -->
        <div id="monitor-users" class="content-section">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Monitor Users</h3>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-primary" onclick="openCreateMonitorModal()">
                            <i class="fas fa-plus"></i> Create Monitor
                        </button>
                        <button class="btn btn-primary" onclick="loadMonitorUsers()">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Display Name</th>
                                <th>Total Logins</th>
                                <th>Last Login</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="monitorUsersTable">
                            <tr><td colspan="6" class="text-center">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Referrals Section -->
        <div id="referrals" class="content-section">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Referral System</h3>
                    <button class="btn btn-primary" onclick="loadReferrals()">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Referrer</th>
                                <th>Referred User</th>
                                <th>Commission</th>
                                <th>Status</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody id="referralsTable">
                            <tr><td colspan="5" class="text-center">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Analytics Section -->
        <div id="analytics" class="content-section">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Analytics</h3>
                    <button class="btn btn-primary" onclick="loadAnalytics()">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Bets</div>
                        <div class="stat-value" id="totalBetsCount">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Bet Amount</div>
                        <div class="stat-value" id="totalBetsAmount">₹0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Deposits</div>
                        <div class="stat-value" id="totalDepositsAmount">₹0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Withdrawals</div>
                        <div class="stat-value" id="totalWithdrawalsAmount">₹0</div>
                    </div>
                </div>
                <div id="analyticsData"></div>
            </div>
        </div>

        <!-- Settings Section -->
        <div id="settings" class="content-section">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Settings</h3>
                </div>
                <div style="max-width: 500px;">
                    <h4 style="margin-bottom: 20px;">Account Settings</h4>
                    <div class="input-group">
                        <label>Current Username</label>
                        <input type="text" id="currentUsername" value="admin" disabled>
                    </div>
                    <div class="input-group">
                        <label>New Password</label>
                        <input type="password" id="newPassword" placeholder="Enter new password">
                    </div>
                    <div class="input-group">
                        <label>Confirm Password</label>
                        <input type="password" id="confirmPassword" placeholder="Confirm new password">
                    </div>
                    <button class="btn btn-primary" onclick="updatePassword()">
                        <i class="fas fa-save"></i> Update Password
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Gift Code Modal -->
    <div id="createGiftCodeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create Gift Code</h3>
                <button class="close-btn" onclick="closeCreateGiftCodeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label>Code (auto-generated)</label>
                    <input type="text" id="giftCodeCode" placeholder="Leave empty for auto-generation">
                </div>
                <div class="input-group">
                    <label>Amount (₹)</label>
                    <input type="number" id="giftCodeAmount" placeholder="Enter amount" min="10" required>
                </div>
                <div class="input-group">
                    <label>Type</label>
                    <select id="giftCodeType" required>
                        <option value="one-to-one">One-to-One (Single Use)</option>
                        <option value="one-to-many">One-to-Many (Multiple Uses)</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Max Redemptions</label>
                    <input type="number" id="giftCodeMaxRedemptions" placeholder="Enter max redemptions" min="1" value="1" required>
                </div>
                <div class="input-group">
                    <label>Validity Days</label>
                    <input type="number" id="giftCodeValidityDays" placeholder="Enter validity in days" min="1" value="7" required>
                </div>
                <div class="input-group">
                    <label>Description (optional)</label>
                    <textarea id="giftCodeDescription" placeholder="Enter description" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeCreateGiftCodeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="createGiftCode()">Create</button>
            </div>
        </div>
    </div>

    <!-- Create Monitor User Modal -->
    <div id="createMonitorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create Monitor User</h3>
                <button class="close-btn" onclick="closeCreateMonitorModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label>Username</label>
                    <input type="text" id="monitorUsername" placeholder="Enter username">
                </div>
                <div class="input-group">
                    <label>Password</label>
                    <input type="password" id="monitorPassword" placeholder="Enter password">
                </div>
                <div class="input-group">
                    <label>Display Name</label>
                    <input type="text" id="monitorDisplayName" placeholder="Enter display name">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeCreateMonitorModal()">Cancel</button>
                <button class="btn btn-primary" onclick="createMonitorUser()">Create</button>
            </div>
        </div>
    </div>

    <!-- View User Modal -->
    <div id="viewUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">User Details</h3>
                <button class="close-btn" onclick="closeViewUserModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="userDetails">
                <!-- Details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeViewUserModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Edit Balance Modal -->
    <div id="editBalanceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit User Balance</h3>
                <button class="close-btn" onclick="closeEditBalanceModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label>User Mobile</label>
                    <input type="text" id="editBalanceMobile" disabled>
                </div>
                <div class="input-group">
                    <label>Balance Type</label>
                    <select id="editBalanceType">
                        <option value="wallet">Wallet Balance</option>
                        <option value="bonus">Bonus Balance</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Amount (₹) - Use negative to deduct</label>
                    <input type="number" id="editBalanceAmount" placeholder="e.g., 100 or -50" step="0.01">
                </div>
                <div class="input-group">
                    <label>Reason</label>
                    <input type="text" id="editBalanceReason" placeholder="Enter reason for adjustment">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeEditBalanceModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveBalanceEdit()">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_URL = 'https://color-game-backend1.onrender.com';
        let token = localStorage.getItem('adminToken');
        let allUsers = [];
        let allGiftCodes = [];
        let allDeposits = [];
        let allWithdrawals = [];
        let allBets = [];
        let allRounds = [];
        let allReferrals = [];

        // Check authentication
        if (!token) {
            window.location.href = 'admin-login.html';
        }

        // Check token expiry
        const loginTime = localStorage.getItem('adminLoginTime');
        if (loginTime) {
            const elapsed = Date.now() - parseInt(loginTime);
            const twentyFourHours = 24 * 60 * 60 * 1000;
            
            if (elapsed >= twentyFourHours) {
                console.log('Token expired');
                localStorage.removeItem('adminToken');
                localStorage.removeItem('adminLoginTime');
                window.location.href = 'admin-login.html';
            }
        }

        // Set admin name
        document.getElementById('adminName').textContent = 'Admin';
        document.getElementById('userAvatar').textContent = 'A';
        document.getElementById('currentUsername').value = 'admin';

        // Navigation
        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', function() {
                const section = this.dataset.section;
                
                // Update active menu item
                document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
                this.classList.add('active');
                
                // Update active section
                document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
                document.getElementById(section).classList.add('active');
                
                // Update page title
                const titles = {
                    'dashboard': 'Dashboard',
                    'users': 'Users Management',
                    'gift-codes': 'Gift Codes',
                    'deposits': 'Deposits',
                    'withdrawals': 'Withdrawals',
                    'bets': 'Bets History',
                    'rounds': 'Game Rounds',
                    'monitor-users': 'Monitor Users',
                    'referrals': 'Referral System',
                    'analytics': 'Analytics',
                    'settings': 'Settings'
                };
                document.getElementById('pageTitle').textContent = titles[section] || 'Dashboard';
                
                // Load section data
                loadSectionData(section);
            });
        });

        // Load section data
        function loadSectionData(section) {
            switch(section) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'gift-codes':
                    loadGiftCodes();
                    break;
                case 'deposits':
                    loadDeposits();
                    break;
                case 'withdrawals':
                    loadWithdrawals();
                    break;
                case 'bets':
                    loadBets();
                    break;
                case 'rounds':
                    loadRounds();
                    break;
                case 'monitor-users':
                    loadMonitorUsers();
                    break;
                case 'referrals':
                    loadReferrals();
                    break;
                case 'analytics':
                    loadAnalytics();
                    break;
            }
        }

        // API Helper - Token already has "Bearer " prefix
        async function apiCall(endpoint, method = 'GET', body = null) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': token  // Token already has "Bearer " prefix
                }
            };
            
            if (body) {
                options.body = JSON.stringify(body);
            }
            
            try {
                const response = await fetch(`${API_URL}${endpoint}`, options);
                
                if (!response.ok) {
                    if (response.status === 401) {
                        console.error('Authentication failed - redirecting to login');
                        localStorage.removeItem('adminToken');
                        localStorage.removeItem('adminLoginTime');
                        window.location.href = 'admin-login.html';
                        return null;
                    }
                    
                    let data;
                    try {
                        data = await response.json();
                    } catch (e) {
                        throw new Error(`Request failed with status ${response.status}`);
                    }
                    throw new Error(data.error || 'Request failed');
                }
                
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                alert('Error: ' + error.message);
                return null;
            }
        }

        // Load Dashboard
        async function loadDashboard() {
            try {
                const stats = await apiCall('/admin/dashboard-stats');
                if (stats) {
                    document.getElementById('totalUsers').textContent = stats.totalUsers || 0;
                    document.getElementById('totalRevenue').textContent = `₹${(stats.totalDeposits || 0).toFixed(2)}`;
                    document.getElementById('pendingWithdrawals').textContent = stats.pendingWithdraws || 0;
                }

                const giftCodesData = await apiCall('/admin/giftcodes');
                if (giftCodesData && giftCodesData.giftCodes) {
                    const active = giftCodesData.giftCodes.filter(g => g.status === 'active').length;
                    document.getElementById('activeGiftCodes').textContent = active;
                }

                // Load recent activity
                loadRecentActivity();
            } catch (error) {
                console.error('Dashboard load error:', error);
            }
        }

        // Load Recent Activity - FIXED
        async function loadRecentActivity() {
            const activity = document.getElementById('recentActivity');
            activity.innerHTML = '<p class="text-center">Loading recent activity...</p>';
            
            try {
                const deposits = await apiCall('/admin/deposits');
                const withdrawals = await apiCall('/admin/withdraws');
                
                let recentItems = [];
                
                if (deposits && Array.isArray(deposits) && deposits.length > 0) {
                    recentItems = recentItems.concat(deposits.slice(0, 5).map(d => ({
                        type: 'Deposit',
                        user: d.mobile,
                        amount: d.amount,
                        status: d.status,
                        time: new Date(d.createdAt)
                    })));
                }
                
                if (withdrawals && Array.isArray(withdrawals) && withdrawals.length > 0) {
                    recentItems = recentItems.concat(withdrawals.slice(0, 5).map(w => ({
                        type: 'Withdrawal',
                        user: w.mobile,
                        amount: w.amount,
                        status: w.status,
                        time: new Date(w.createdAt)
                    })));
                }
                
                recentItems.sort((a, b) => b.time - a.time);
                recentItems = recentItems.slice(0, 10);
                
                if (recentItems.length > 0) {
                    activity.innerHTML = recentItems.map(item => `
                        <div class="activity-item">
                            <div class="activity-content">
                                <div class="activity-info">
                                    <strong>${item.type}</strong> - ${item.user}
                                    <span class="badge ${getBadgeClass(item.status)}" style="margin-left: 10px;">${item.status}</span>
                                    <div class="activity-time">${item.time.toLocaleString()}</div>
                                </div>
                                <div class="activity-amount">
                                    <strong>₹${item.amount}</strong>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    activity.innerHTML = '<p class="text-center">No recent activity</p>';
                }
            } catch (error) {
                console.error('Activity load error:', error);
                activity.innerHTML = '<p class="text-center">Error loading activity</p>';
            }
        }

        // Load Users
        async function loadUsers() {
            const tbody = document.getElementById('usersTable');
            tbody.innerHTML = '<tr><td colspan="8" class="text-center">Loading...</td></tr>';
            
            const users = await apiCall('/admin/users');
            if (users) {
                allUsers = users;
                displayUsers(users);
            }
        }

        function displayUsers(users) {
            const tbody = document.getElementById('usersTable');
            tbody.innerHTML = users.length ? users.map(user => `
                <tr>
                    <td>${user.mobile}</td>
                    <td>₹${user.wallet?.toFixed(2) || '0.00'}</td>
                    <td>₹${user.bonus?.toFixed(2) || '0.00'}</td>
                    <td>₹${user.totalDeposit?.toFixed(2) || '0.00'}</td>
                    <td>₹${user.totalWithdraw?.toFixed(2) || '0.00'}</td>
                    <td><span class="badge ${user.isBanned ? 'danger' : 'success'}">${user.isBanned ? 'Banned' : 'Active'}</span></td>
                    <td>${new Date(user.createdAt).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewUser('${user.mobile}')" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-success" onclick="openEditBalanceModal('${user.mobile}')" title="Edit Balance">
                            <i class="fas fa-edit"></i>
                        </button>
                        ${user.isBanned ? 
                            `<button class="btn btn-sm btn-success" onclick="unbanUser('${user.mobile}')" title="Unban User">
                                <i class="fas fa-check"></i>
                            </button>` :
                            `<button class="btn btn-sm btn-danger" onclick="banUser('${user.mobile}')" title="Ban User">
                                <i class="fas fa-ban"></i>
                            </button>`
                        }
                    </td>
                </tr>
            `).join('') : '<tr><td colspan="8" class="text-center">No users found</td></tr>';
        }

        function filterUsers() {
            const status = document.getElementById('userStatusFilter').value;
            const search = document.getElementById('userSearch').value.toLowerCase();
            
            let filtered = allUsers;
            
            if (status) {
                filtered = filtered.filter(u => {
                    if (status === 'active') return !u.isBanned;
                    if (status === 'banned') return u.isBanned;
                    return true;
                });
            }
            
            if (search) {
                filtered = filtered.filter(u => u.mobile.includes(search));
            }
            
            displayUsers(filtered);
        }

        async function viewUser(mobile) {
            const user = allUsers.find(u => u.mobile === mobile);
            if (!user) return;

            const details = document.getElementById('userDetails');
            details.innerHTML = `
                <div class="input-group">
                    <label>Mobile</label>
                    <input type="text" value="${user.mobile}" disabled>
                </div>
                <div class="input-group">
                    <label>Wallet Balance</label>
                    <input type="text" value="₹${user.wallet?.toFixed(2) || '0.00'}" disabled>
                </div>
                <div class="input-group">
                    <label>Bonus Balance</label>
                    <input type="text" value="₹${user.bonus?.toFixed(2) || '0.00'}" disabled>
                </div>
                <div class="input-group">
                    <label>Total Deposits</label>
                    <input type="text" value="₹${user.totalDeposit?.toFixed(2) || '0.00'}" disabled>
                </div>
                <div class="input-group">
                    <label>Total Withdrawals</label>
                    <input type="text" value="₹${user.totalWithdraw?.toFixed(2) || '0.00'}" disabled>
                </div>
                <div class="input-group">
                    <label>Referral Code</label>
                    <input type="text" value="${user.referralCode || 'N/A'}" disabled>
                </div>
                <div class="input-group">
                    <label>Status</label>
                    <input type="text" value="${user.isBanned ? 'Banned' : 'Active'}" disabled>
                </div>
                <div class="input-group">
                    <label>Registered</label>
                    <input type="text" value="${new Date(user.createdAt).toLocaleString()}" disabled>
                </div>
            `;

            document.getElementById('viewUserModal').classList.add('active');
        }

        function closeViewUserModal() {
            document.getElementById('viewUserModal').classList.remove('active');
        }

        // Edit Balance Functions - NEW
        function openEditBalanceModal(mobile) {
            document.getElementById('editBalanceMobile').value = mobile;
            document.getElementById('editBalanceType').value = 'wallet';
            document.getElementById('editBalanceAmount').value = '';
            document.getElementById('editBalanceReason').value = '';
            document.getElementById('editBalanceModal').classList.add('active');
        }

        function closeEditBalanceModal() {
            document.getElementById('editBalanceModal').classList.remove('active');
        }

        async function saveBalanceEdit() {
            const mobile = document.getElementById('editBalanceMobile').value;
            const type = document.getElementById('editBalanceType').value;
            const amount = parseFloat(document.getElementById('editBalanceAmount').value);
            const reason = document.getElementById('editBalanceReason').value;

            if (!amount || isNaN(amount)) {
                alert('Please enter a valid amount');
                return;
            }

            if (!reason) {
                alert('Please enter a reason for this adjustment');
                return;
            }

            const result = await apiCall(`/admin/user/${mobile}/adjust-balance`, 'POST', {
                amount,
                type,
                reason
            });

            if (result) {
                alert(`Balance adjusted successfully!\nNew Wallet: ₹${result.newWallet}\nNew Bonus: ₹${result.newBonus}`);
                closeEditBalanceModal();
                loadUsers();
            }
        }

        async function banUser(mobile) {
            if (!confirm(`Ban user ${mobile}?`)) return;
            
            const result = await apiCall(`/admin/user/${mobile}/ban`, 'POST');
            if (result) {
                alert('User banned successfully');
                loadUsers();
            }
        }

        async function unbanUser(mobile) {
            if (!confirm(`Unban user ${mobile}?`)) return;
            
            const result = await apiCall(`/admin/user/${mobile}/unban`, 'POST');
            if (result) {
                alert('User unbanned successfully');
                loadUsers();
            }
        }

        // Load Gift Codes - FIXED
        async function loadGiftCodes() {
            const tbody = document.getElementById('giftCodesTable');
            tbody.innerHTML = '<tr><td colspan="9" class="text-center">Loading...</td></tr>';
            
            const data = await apiCall('/admin/giftcodes');
            if (data && data.giftCodes) {
                allGiftCodes = data.giftCodes;
                displayGiftCodes(data.giftCodes);
            }
        }

        function displayGiftCodes(codes) {
            const tbody = document.getElementById('giftCodesTable');
            tbody.innerHTML = codes.length ? codes.map(gc => `
                <tr>
                    <td><strong>${gc.code}</strong></td>
                    <td>₹${gc.amount}</td>
                    <td>${gc.type === 'one-to-one' ? 'Single Use' : 'Multiple Uses'}</td>
                    <td>${gc.maxRedemptions || 1}</td>
                    <td>${gc.redemptionCount || 0}</td>
                    <td>${new Date(gc.expiryDate).toLocaleDateString()}</td>
                    <td><span class="badge ${getBadgeClass(gc.status)}">${gc.status}</span></td>
                    <td>${gc.creatorMobile || 'Admin'}</td>
                    <td>
                        ${gc.status === 'active' ? 
                            `<button class="btn btn-sm btn-danger" onclick="deleteGiftCode('${gc.code}')">
                                <i class="fas fa-trash"></i>
                            </button>` : 
                            '<span style="color: var(--text-light);">-</span>'
                        }
                    </td>
                </tr>
            `).join('') : '<tr><td colspan="9" class="text-center">No gift codes found</td></tr>';
        }

        function filterGiftCodes() {
            const status = document.getElementById('giftCodeStatusFilter').value;
            const search = document.getElementById('giftCodeSearch').value.toLowerCase();
            
            let filtered = allGiftCodes;
            
            if (status) {
                filtered = filtered.filter(g => g.status === status);
            }
            
            if (search) {
                filtered = filtered.filter(g => g.code.toLowerCase().includes(search));
            }
            
            displayGiftCodes(filtered);
        }

        function openCreateGiftCodeModal() {
            document.getElementById('createGiftCodeModal').classList.add('active');
        }

        function closeCreateGiftCodeModal() {
            document.getElementById('createGiftCodeModal').classList.remove('active');
            document.getElementById('giftCodeCode').value = '';
            document.getElementById('giftCodeAmount').value = '';
            document.getElementById('giftCodeType').value = 'one-to-one';
            document.getElementById('giftCodeMaxRedemptions').value = '1';
            document.getElementById('giftCodeValidityDays').value = '7';
            document.getElementById('giftCodeDescription').value = '';
        }

        async function createGiftCode() {
            const amount = parseFloat(document.getElementById('giftCodeAmount').value);
            const type = document.getElementById('giftCodeType').value;
            const maxRedemptions = parseInt(document.getElementById('giftCodeMaxRedemptions').value);
            const validityDays = parseInt(document.getElementById('giftCodeValidityDays').value);
            const description = document.getElementById('giftCodeDescription').value;

            if (!amount || amount < 10) {
                alert('Minimum amount is ₹10');
                return;
            }

            if (!maxRedemptions || maxRedemptions < 1) {
                alert('Max redemptions must be at least 1');
                return;
            }

            if (!validityDays || validityDays < 1) {
                alert('Validity days must be at least 1');
                return;
            }

            // Note: Admin creates gift codes through user endpoint but needs actual user context
            // This is a limitation - admin should have their own gift code creation endpoint
            alert('Gift code creation from admin panel requires backend implementation of /admin/giftcode/create endpoint');
        }

        async function deleteGiftCode(code) {
            if (!confirm('Delete this gift code?')) return;

            const result = await apiCall(`/admin/giftcode/${code}`, 'DELETE');
            if (result) {
                alert('Gift code deleted successfully');
                loadGiftCodes();
            }
        }

        // Load Deposits
        async function loadDeposits() {
            const tbody = document.getElementById('depositsTable');
            tbody.innerHTML = '<tr><td colspan="7" class="text-center">Loading...</td></tr>';
            
            const deposits = await apiCall('/admin/deposits');
            if (deposits) {
                allDeposits = deposits;
                displayDeposits(deposits);
            }
        }

        function displayDeposits(deposits) {
            const tbody = document.getElementById('depositsTable');
            tbody.innerHTML = deposits.length ? deposits.map(d => `
                <tr>
                    <td>${d.orderId || 'N/A'}</td>
                    <td>${d.mobile}</td>
                    <td>₹${d.amount}</td>
                    <td><span class="badge ${getBadgeClass(d.status)}">${d.status}</span></td>
                    <td>${d.method || 'UPI'}</td>
                    <td>${new Date(d.createdAt).toLocaleString()}</td>
                    <td>
                        ${d.status === 'PENDING' ? 
                            `<button class="btn btn-sm btn-success" onclick="approveDeposit('${d._id}')" title="Approve">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="rejectDeposit('${d._id}')" title="Reject">
                                <i class="fas fa-times"></i>
                            </button>` : 
                            '-'
                        }
                    </td>
                </tr>
            `).join('') : '<tr><td colspan="7" class="text-center">No deposits found</td></tr>';
        }

        function filterDeposits() {
            const status = document.getElementById('depositStatusFilter').value;
            const search = document.getElementById('depositSearch').value.toLowerCase();
            
            let filtered = allDeposits;
            
            if (status) {
                filtered = filtered.filter(d => d.status === status);
            }
            
            if (search) {
                filtered = filtered.filter(d => d.mobile.includes(search));
            }
            
            displayDeposits(filtered);
        }

        async function approveDeposit(id) {
            if (!confirm('Approve this deposit?')) return;

            const result = await apiCall(`/admin/deposit/${id}`, 'POST');
            if (result) {
                alert('Deposit approved successfully');
                loadDeposits();
                loadDashboard(); // Refresh stats
            }
        }

        async function rejectDeposit(id) {
            if (!confirm('Reject this deposit? This cannot be undone.')) return;

            // Note: Backend needs reject endpoint implementation
            alert('Deposit rejection requires backend endpoint implementation');
        }

        // Load Withdrawals
        async function loadWithdrawals() {
            const tbody = document.getElementById('withdrawalsTable');
            tbody.innerHTML = '<tr><td colspan="7" class="text-center">Loading...</td></tr>';
            
            const withdrawals = await apiCall('/admin/withdraws');
            if (withdrawals) {
                allWithdrawals = withdrawals;
                displayWithdrawals(withdrawals);
            }
        }

        function displayWithdrawals(withdrawals) {
            const tbody = document.getElementById('withdrawalsTable');
            tbody.innerHTML = withdrawals.length ? withdrawals.map(w => `
                <tr>
                    <td>${w.mobile}</td>
                    <td>₹${w.amount}</td>
                    <td>${w.accountNumber}</td>
                    <td>${w.ifscCode}</td>
                    <td><span class="badge ${getBadgeClass(w.status)}">${w.status}</span></td>
                    <td>${new Date(w.createdAt).toLocaleString()}</td>
                    <td>
                        ${w.status === 'PENDING' ? `
                            <button class="btn btn-sm btn-success" onclick="approveWithdrawal('${w._id}')" title="Approve">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="rejectWithdrawal('${w._id}')" title="Reject">
                                <i class="fas fa-times"></i>
                            </button>
                        ` : '-'}
                    </td>
                </tr>
            `).join('') : '<tr><td colspan="7" class="text-center">No withdrawals found</td></tr>';
        }

        function filterWithdrawals() {
            const status = document.getElementById('withdrawalStatusFilter').value;
            const search = document.getElementById('withdrawalSearch').value.toLowerCase();
            
            let filtered = allWithdrawals;
            
            if (status) {
                filtered = filtered.filter(w => w.status === status);
            }
            
            if (search) {
                filtered = filtered.filter(w => w.mobile.includes(search));
            }
            
            displayWithdrawals(filtered);
        }

        async function approveWithdrawal(id) {
            if (!confirm('Approve this withdrawal?')) return;

            const result = await apiCall(`/admin/withdraw/${id}`, 'POST', { action: 'approve' });
            if (result) {
                alert('Withdrawal approved successfully');
                loadWithdrawals();
                loadDashboard(); // Refresh stats
            }
        }

        async function rejectWithdrawal(id) {
            if (!confirm('Reject this withdrawal? Amount will be returned to user wallet.')) return;

            const result = await apiCall(`/admin/withdraw/${id}`, 'POST', { action: 'reject' });
            if (result) {
                alert('Withdrawal rejected successfully');
                loadWithdrawals();
            }
        }

        // Load Bets - FIXED
        async function loadBets() {
            const tbody = document.getElementById('betsTable');
            tbody.innerHTML = '<tr><td colspan="7" class="text-center">Loading...</td></tr>';
            
            try {
                // Use the user analytics endpoint to get bet data
                const analytics = await apiCall('/admin/user-analytics');
                
                if (analytics && analytics.recentBets && analytics.recentBets.length > 0) {
                    allBets = analytics.recentBets;
                    displayBets(analytics.recentBets);
                } else {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center">No bets found</td></tr>';
                }
            } catch (error) {
                console.error('Bets load error:', error);
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">Error loading bets</td></tr>';
            }
        }

        function displayBets(bets) {
            const tbody = document.getElementById('betsTable');
            tbody.innerHTML = bets.length ? bets.map(bet => `
                <tr>
                    <td>${bet.mobile}</td>
                    <td>${bet.roundId}</td>
                    <td>${bet.betType || bet.selection}</td>
                    <td>₹${bet.amount}</td>
                    <td><span class="badge ${bet.result === 'WIN' ? 'success' : 'danger'}">${bet.result || 'PENDING'}</span></td>
                    <td>₹${bet.winAmount || '0.00'}</td>
                    <td>${new Date(bet.createdAt).toLocaleString()}</td>
                </tr>
            `).join('') : '<tr><td colspan="7" class="text-center">No bets found</td></tr>';
        }

        function filterBets() {
            const result = document.getElementById('betResultFilter').value;
            const search = document.getElementById('betSearch').value.toLowerCase();
            
            let filtered = allBets;
            
            if (result) {
                filtered = filtered.filter(b => b.result === result);
            }
            
            if (search) {
                filtered = filtered.filter(b => b.mobile.includes(search));
            }
            
            displayBets(filtered);
        }

        // Load Rounds - FIXED
        async function loadRounds() {
            const tbody = document.getElementById('roundsTable');
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">Loading...</td></tr>';
            
            try {
                // Use game analytics endpoint to get round data
                const analytics = await apiCall('/admin/game-analytics');
                
                if (analytics && analytics.recentRounds && analytics.recentRounds.length > 0) {
                    allRounds = analytics.recentRounds;
                    displayRounds(analytics.recentRounds);
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center">No rounds found</td></tr>';
                }
            } catch (error) {
                console.error('Rounds load error:', error);
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">Error loading rounds</td></tr>';
            }
        }

        function displayRounds(rounds) {
            const tbody = document.getElementById('roundsTable');
            tbody.innerHTML = rounds.length ? rounds.map(round => `
                <tr>
                    <td>${round.roundId}</td>
                    <td><span class="badge ${round.winner ? 'success' : 'warning'}">${round.winner || 'In Progress'}</span></td>
                    <td>${round.totalBets || 0}</td>
                    <td>₹${round.totalBetAmount?.toFixed(2) || '0.00'}</td>
                    <td>${new Date(round.createdAt).toLocaleString()}</td>
                </tr>
            `).join('') : '<tr><td colspan="5" class="text-center">No rounds found</td></tr>';
        }

        // Load Monitor Users
        async function loadMonitorUsers() {
            const tbody = document.getElementById('monitorUsersTable');
            tbody.innerHTML = '<tr><td colspan="6" class="text-center">Loading...</td></tr>';
            
            const monitors = await apiCall('/admin/monitor-users');
            if (monitors) {
                displayMonitorUsers(monitors);
            }
        }

        function displayMonitorUsers(monitors) {
            const tbody = document.getElementById('monitorUsersTable');
            tbody.innerHTML = monitors.length ? monitors.map(m => `
                <tr>
                    <td>${m.username}</td>
                    <td>${m.displayName}</td>
                    <td>${m.totalLogins || 0}</td>
                    <td>${m.lastLogin ? new Date(m.lastLogin).toLocaleString() : 'Never'}</td>
                    <td><span class="badge ${m.active ? 'success' : 'danger'}">${m.active ? 'Active' : 'Inactive'}</span></td>
                    <td>
                        <button class="btn btn-sm ${m.active ? 'btn-danger' : 'btn-success'}" 
                                onclick="toggleMonitor('${m._id}', ${!m.active})">
                            ${m.active ? '<i class="fas fa-ban"></i> Disable' : '<i class="fas fa-check"></i> Enable'}
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteMonitor('${m._id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('') : '<tr><td colspan="6" class="text-center">No monitor users found</td></tr>';
        }

        function openCreateMonitorModal() {
            document.getElementById('createMonitorModal').classList.add('active');
        }

        function closeCreateMonitorModal() {
            document.getElementById('createMonitorModal').classList.remove('active');
            document.getElementById('monitorUsername').value = '';
            document.getElementById('monitorPassword').value = '';
            document.getElementById('monitorDisplayName').value = '';
        }

        async function createMonitorUser() {
            const username = document.getElementById('monitorUsername').value;
            const password = document.getElementById('monitorPassword').value;
            const displayName = document.getElementById('monitorDisplayName').value;

            if (!username || !password) {
                alert('Username and password required');
                return;
            }

            if (password.length < 6) {
                alert('Password must be at least 6 characters');
                return;
            }

            const result = await apiCall('/admin/monitor-user', 'POST', {
                username,
                password,
                displayName: displayName || username
            });

            if (result) {
                alert('Monitor user created successfully');
                closeCreateMonitorModal();
                loadMonitorUsers();
            }
        }

        async function toggleMonitor(id, active) {
            const result = await apiCall(`/admin/monitor-user/${id}/toggle`, 'POST', { active });
            if (result) {
                alert(`Monitor user ${active ? 'enabled' : 'disabled'} successfully`);
                loadMonitorUsers();
            }
        }

        async function deleteMonitor(id) {
            if (!confirm('Delete this monitor user?')) return;

            const result = await apiCall(`/admin/monitor-user/${id}`, 'DELETE');
            if (result) {
                alert('Monitor user deleted successfully');
                loadMonitorUsers();
            }
        }

        // Load Referrals - FIXED
        async function loadReferrals() {
            const tbody = document.getElementById('referralsTable');
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">Loading...</td></tr>';
            
            try {
                // Fetch all users and build referral data from their referralCode and referredBy
                const users = await apiCall('/admin/users');
                
                if (users && users.length > 0) {
                    // Filter users who were referred by someone
                    const referrals = users.filter(u => u.referredBy).map(u => ({
                        referrer: u.referredBy,
                        referred: u.mobile,
                        commission: 50, // Default commission amount
                        status: 'PAID',
                        date: u.createdAt
                    }));
                    
                    allReferrals = referrals;
                    displayReferrals(referrals);
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center">No referrals found</td></tr>';
                }
            } catch (error) {
                console.error('Referrals load error:', error);
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">Error loading referrals</td></tr>';
            }
        }

        function displayReferrals(referrals) {
            const tbody = document.getElementById('referralsTable');
            tbody.innerHTML = referrals.length ? referrals.map(r => `
                <tr>
                    <td>${r.referrer}</td>
                    <td>${r.referred}</td>
                    <td>₹${r.commission}</td>
                    <td><span class="badge success">${r.status}</span></td>
                    <td>${new Date(r.date).toLocaleString()}</td>
                </tr>
            `).join('') : '<tr><td colspan="5" class="text-center">No referrals found</td></tr>';
        }

        // Load Analytics
        async function loadAnalytics() {
            try {
                const stats = await apiCall('/admin/stats');
                if (stats) {
                    document.getElementById('totalBetsCount').textContent = stats.totalBets || 0;
                    document.getElementById('totalBetsAmount').textContent = `₹${(stats.totalBetAmount || 0).toFixed(2)}`;
                    document.getElementById('totalDepositsAmount').textContent = `₹${(stats.totalDeposits || 0).toFixed(2)}`;
                    document.getElementById('totalWithdrawalsAmount').textContent = `₹${(stats.totalWithdrawals || 0).toFixed(2)}`;
                }

                document.getElementById('analyticsData').innerHTML = '<p class="text-center">Analytics data loaded successfully</p>';
            } catch (error) {
                document.getElementById('analyticsData').innerHTML = '<p class="text-center">Error loading analytics</p>';
            }
        }

        // Helper Functions
        function getBadgeClass(status) {
            const statusMap = {
                'SUCCESS': 'success',
                'APPROVED': 'success',
                'WIN': 'success',
                'PAID': 'success',
                'active': 'success',
                'PENDING': 'warning',
                'FAILED': 'danger',
                'REJECTED': 'danger',
                'LOSS': 'danger',
                'expired': 'danger',
                'fully-redeemed': 'primary'
            };
            return statusMap[status] || 'primary';
        }

        async function updatePassword() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (!newPassword || !confirmPassword) {
                alert('Please fill in all fields');
                return;
            }

            if (newPassword !== confirmPassword) {
                alert('Passwords do not match');
                return;
            }

            if (newPassword.length < 6) {
                alert('Password must be at least 6 characters');
                return;
            }

            alert('Password change functionality requires backend endpoint implementation');
        }

        function logout() {
            localStorage.removeItem('adminToken');
            localStorage.removeItem('adminLoginTime');
            window.location.href = 'admin-login.html';
        }

        // Load initial data
        loadDashboard();
        
        // Set last updated time
        setInterval(() => {
            document.getElementById('lastUpdated').textContent = new Date().toLocaleString();
        }, 1000);
    </script>
</body>
</html>
